name: Auto Create Branch and PR

on:
  issues:
    types: [labeled]

jobs:
  create-branch-and-pr:
    if: github.event.label.name == 'ready-for-dev'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Extract issue details
        id: issue
        run: |
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT

      - name: Generate branch name from issue title
        id: branch-name
        run: |
          TITLE="${{ github.event.issue.title }}"
          SHORT_DESC=$(echo "$TITLE" | \
            tr '[:upper:]' '[:lower:]' | \
            sed 's/[^a-z0-9]/-/g' | \
            sed 's/--*/-/g' | \
            sed 's/^-\|-$//g' | \
            cut -c1-50 | \
            sed 's/-$//')
          
          if [ -z "$SHORT_DESC" ] || [ ${#SHORT_DESC} -lt 3 ]; then
            SHORT_DESC="feature"
          fi
          
          BRANCH_NAME="issue-${{ github.event.issue.number }}-${SHORT_DESC}"
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Generated branch name: ${BRANCH_NAME}"

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Check if branch already exists
        id: check-branch
        run: |
          BRANCH_NAME="${{ steps.branch-name.outputs.name }}"
          BRANCH_EXISTS=$(gh api repos/${{ github.repository }}/git/ref/heads/$BRANCH_NAME --jq '.ref' 2>/dev/null || echo "")
          if [ -n "$BRANCH_EXISTS" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Branch $BRANCH_NAME already exists, skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Branch $BRANCH_NAME does not exist, proceeding"
          fi

      - name: Check if PR already exists for this issue
        id: check-pr
        if: steps.check-branch.outputs.exists == 'false'
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          EXISTING_PR=$(gh pr list --state all --search "#${ISSUE_NUMBER}" --json number --jq '.[0].number' || echo "")
          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "PR #${EXISTING_PR} already exists for issue #${ISSUE_NUMBER}, skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found for issue #${ISSUE_NUMBER}, proceeding"
          fi

      - name: Checkout repository
        if: steps.check-branch.outputs.exists == 'false' && steps.check-pr.outputs.exists == 'false'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure git
        if: steps.check-branch.outputs.exists == 'false' && steps.check-pr.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch from main
        if: steps.check-branch.outputs.exists == 'false' && steps.check-pr.outputs.exists == 'false'
        run: |
          BRANCH_NAME="${{ steps.branch-name.outputs.name }}"
          git checkout main
          git pull origin main
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          echo "Created and pushed branch: $BRANCH_NAME"

      - name: Create draft PR
        if: steps.check-branch.outputs.exists == 'false' && steps.check-pr.outputs.exists == 'false'
        id: create-pr
        run: |
          BRANCH_NAME="${{ steps.branch-name.outputs.name }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          
          PR_BODY="Implements issue #${ISSUE_NUMBER} - ${ISSUE_TITLE}

## Changes
- [To be filled during implementation]

## Related Issue
Related to #${ISSUE_NUMBER}

## Testing
- [ ] Security tests pass
- [ ] Functionality tests pass
- [ ] Manual testing completed

## Checklist
- [ ] Code follows project style guidelines
- [ ] Tests added/updated
- [ ] Documentation updated (if needed)"
          
          PR_URL=$(gh pr create --draft \
            --title "[#${ISSUE_NUMBER}] ${ISSUE_TITLE}" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME")
          
          echo "url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "number=$(echo $PR_URL | sed 's/.*\/pull\/\([0-9]*\)/\1/')" >> $GITHUB_OUTPUT
          echo "Created draft PR: $PR_URL"

      - name: Update issue labels
        if: steps.check-branch.outputs.exists == 'false' && steps.check-pr.outputs.exists == 'false' && steps.create-pr.outputs.url != ''
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "ready-for-dev" \
            --add-label "in-progress"
          echo "Updated labels: removed ready-for-dev, added in-progress"

      - name: Comment on issue
        if: steps.check-branch.outputs.exists == 'false' && steps.check-pr.outputs.exists == 'false' && steps.create-pr.outputs.url != ''
        run: |
          BRANCH_NAME="${{ steps.branch-name.outputs.name }}"
          PR_URL="${{ steps.create-pr.outputs.url }}"
          PR_NUMBER="${{ steps.create-pr.outputs.number }}"
          
          COMMENT="## Branch and PR Created Automatically
          
          A branch and draft PR have been created for this issue:
          
          - **Branch**: \`${BRANCH_NAME}\`
          - **Pull Request**: [#${PR_NUMBER}](${PR_URL})
          
          The PR is in draft status. Start implementing and tests will run automatically on each push.
          
          Next steps:
          1. Checkout the branch: \`git checkout ${BRANCH_NAME}\`
          2. Start implementing according to the strategy
          3. Make atomic commits mapping to acceptance criteria
          4. Push regularly - tests run automatically"
          
          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"
          echo "Commented on issue #${{ github.event.issue.number }}"

      - name: Skip message
        if: steps.check-branch.outputs.exists == 'true' || steps.check-pr.outputs.exists == 'true'
        run: |
          if [ "${{ steps.check-branch.outputs.exists }}" == "true" ]; then
            echo "Skipping: Branch already exists"
          fi
          if [ "${{ steps.check-pr.outputs.exists }}" == "true" ]; then
            echo "Skipping: PR already exists for this issue"
          fi
