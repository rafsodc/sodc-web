# SODC Access Control Mutations
#
# Mutations related to sections, access groups, and access control.
# These mutations are accessible from the frontend/client SDK and require admin authentication.
#
# Auth Expression Constants:
# - Admin access: "auth.token.admin == true && auth.token.enabled == true"
# See AUTH_EXPRESSIONS.md for complete documentation and usage.

# Create a new section (admin only - admins must also be enabled)
mutation CreateSection(
  $name: String!
  $type: SectionType!
  $description: String
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  section_insert(
    data: {
      name: $name
      type: $type
      description: $description
    }
  )
}

# Create a new access group (admin only - admins must also be enabled)
mutation CreateAccessGroup(
  $name: String!
  $description: String
  $membershipStatuses: [MembershipStatus!]
  $subscribable: Boolean
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  accessGroup_insert(
    data: {
      name: $name
      description: $description
      membershipStatuses: $membershipStatuses
      subscribable: $subscribable
    }
  )
}

# Add a user to an access group (admin only - admins must also be enabled)
mutation AddUserToAccessGroup(
  $userId: String!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  userAccessGroup_upsert(
    data: {
      userId: $userId
      accessGroupId: $accessGroupId
    }
  )
}

# Remove a user from an access group (admin only - admins must also be enabled)
mutation RemoveUserFromAccessGroup(
  $userId: String!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  userAccessGroup_delete(
    key: {
      userId: $userId
      accessGroupId: $accessGroupId
    }
  )
}

# Grant an access group VIEW access to a section (admin only)
mutation GrantViewAccessGroupToSection(
  $sectionId: UUID!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  sectionViewAccessGroup_upsert(
    data: {
      sectionId: $sectionId
      accessGroupId: $accessGroupId
    }
  )
}

# Revoke an access group's VIEW access to a section (admin only)
mutation RevokeViewAccessGroupFromSection(
  $sectionId: UUID!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  sectionViewAccessGroup_delete(
    key: {
      sectionId: $sectionId
      accessGroupId: $accessGroupId
    }
  )
}

# Grant an access group MEMBER access to a section (admin only)
mutation GrantMemberAccessGroupToSection(
  $sectionId: UUID!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  sectionMemberAccessGroup_upsert(
    data: {
      sectionId: $sectionId
      accessGroupId: $accessGroupId
    }
  )
}

# Revoke an access group's MEMBER access to a section (admin only)
mutation RevokeMemberAccessGroupFromSection(
  $sectionId: UUID!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  sectionMemberAccessGroup_delete(
    key: {
      sectionId: $sectionId
      accessGroupId: $accessGroupId
    }
  )
}

# Update an access group (admin only - admins must also be enabled)
mutation UpdateAccessGroup(
  $id: UUID!
  $name: String!
  $description: String
  $membershipStatuses: [MembershipStatus!]
  $subscribable: Boolean
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  accessGroup_update(
    id: $id
    data: {
      name: $name
      description: $description
      membershipStatuses: $membershipStatuses
      subscribable: $subscribable
      updatedAt_expr: "request.time"
      updatedBy_expr: "auth.uid"
    }
  )
}

# Delete an access group (admin only - admins must also be enabled)
mutation DeleteAccessGroup(
  $id: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  accessGroup_delete(id: $id)
}

# Update a section (admin only - admins must also be enabled)
# Note: type field is not included as it should not be changed after creation
mutation UpdateSection(
  $id: UUID!
  $name: String!
  $description: String
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  section_update(
    id: $id
    data: {
      name: $name
      description: $description
      updatedAt_expr: "request.time"
      updatedBy_expr: "auth.uid"
    }
  )
}

# Delete a section (admin only - admins must also be enabled)
mutation DeleteSection(
  $id: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  section_delete(id: $id)
}

# --- Event mutations (admin only) ---

mutation CreateEvent(
  $sectionId: UUID!
  $title: String!
  $location: String
  $guestOfHonour: String
  $startDateTime: Timestamp!
  $endDateTime: Timestamp!
  $bookingStartDateTime: Timestamp!
  $bookingEndDateTime: Timestamp!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  event_insert(
    data: {
      sectionId: $sectionId
      title: $title
      location: $location
      guestOfHonour: $guestOfHonour
      startDateTime: $startDateTime
      endDateTime: $endDateTime
      bookingStartDateTime: $bookingStartDateTime
      bookingEndDateTime: $bookingEndDateTime
    }
  )
}

mutation UpdateEvent(
  $id: UUID!
  $title: String!
  $location: String
  $guestOfHonour: String
  $startDateTime: Timestamp!
  $endDateTime: Timestamp!
  $bookingStartDateTime: Timestamp!
  $bookingEndDateTime: Timestamp!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  event_update(
    id: $id
    data: {
      title: $title
      location: $location
      guestOfHonour: $guestOfHonour
      startDateTime: $startDateTime
      endDateTime: $endDateTime
      bookingStartDateTime: $bookingStartDateTime
      bookingEndDateTime: $bookingEndDateTime
      updatedAt_expr: "request.time"
      updatedBy_expr: "auth.uid"
    }
  )
}

mutation DeleteEvent(
  $id: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  event_delete(id: $id)
}

# --- TicketType mutations (admin only) ---

mutation CreateTicketType(
  $eventId: UUID!
  $accessGroupId: UUID!
  $title: String!
  $description: String
  $price: Float!
  $sortOrder: Int
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  ticketType_insert(
    data: {
      eventId: $eventId
      accessGroupId: $accessGroupId
      title: $title
      description: $description
      price: $price
      sortOrder: $sortOrder
    }
  )
}

mutation UpdateTicketType(
  $id: UUID!
  $accessGroupId: UUID!
  $title: String!
  $description: String
  $price: Float!
  $sortOrder: Int!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  ticketType_update(
    id: $id
    data: {
      accessGroupId: $accessGroupId
      title: $title
      description: $description
      price: $price
      sortOrder: $sortOrder
      updatedAt_expr: "request.time"
      updatedBy_expr: "auth.uid"
    }
  )
}

mutation DeleteTicketType(
  $id: UUID!
) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  ticketType_delete(id: $id)
}
