# SODC User Queries
#
# Auth Expression Constants:
# - User access: "auth.token.enabled == true"
# - Admin access: "auth.token.admin == true && auth.token.enabled == true"
# - System access: @auth(level: NO_ACCESS)
# See AUTH_EXPRESSIONS.md for complete documentation and usage.
#
# @auth() directives control who can call each operation.

# Get the current authenticated user's profile
# Requires enabled claim (admins must also be enabled)
query GetCurrentUser @auth(expr: "auth.token.enabled == true") {
  user(key: { id_expr: "auth.uid" }) {
    id
    firstName
    lastName
    email
    serviceNumber
    membershipStatus
    isRegular
    isReserve
    isCivilServant
    isIndustry
    createdAt
    updatedAt
  }
}

# Get a user by ID (admin only - admins must also be enabled)
query GetUserById($id: String!) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  user(id: $id) {
    id
    firstName
    lastName
    email
    serviceNumber
    membershipStatus
    isRegular
    isReserve
    isCivilServant
    isIndustry
    createdAt
    updatedAt
    createdBy
    updatedBy
  }
}

# List all users (admin only - admins must also be enabled)
query ListUsers @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  users {
    id
    firstName
    lastName
    email
    serviceNumber
    membershipStatus
    isRegular
    isReserve
    isCivilServant
    isIndustry
    createdAt
    updatedAt
  }
}

# SODC Section and Access Group Queries

# Get all sections (admin only - admins must also be enabled)
query ListSections @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  sections {
    id
    name
    type
    description
    createdAt
    updatedAt
  }
}

# Get sections accessible to the current user
# Requires enabled claim (admins must also be enabled)
query GetSectionsForUser @auth(expr: "auth.token.enabled == true") {
  user(key: { id_expr: "auth.uid" }) {
    id
    # Get access groups this user belongs to
    accessGroups: userAccessGroups_on_user {
      accessGroup {
        id
        name
        # Get sections this access group can access
        sections: sectionAccessGroups_on_accessGroup {
          section {
            id
            name
            type
            description
          }
        }
      }
    }
  }
}

# Get all access groups (admin only - admins must also be enabled)
query ListAccessGroups @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  accessGroups {
    id
    name
    description
    createdAt
    updatedAt
  }
}

# Get access groups for the current user
# Requires enabled claim (admins must also be enabled)
query GetUserAccessGroups @auth(expr: "auth.token.enabled == true") {
  user(key: { id_expr: "auth.uid" }) {
    id
    accessGroups: userAccessGroups_on_user {
      accessGroup {
        id
        name
        description
      }
    }
  }
}


# Get user status for the specified user
query GetUserMembershipStatus($id: String!) @auth(level: NO_ACCESS) {
  user(id: $id) {
    membershipStatus
  }
}