# SODC User Queries
#
# Auth Expression Constants:
# - User access: "auth.token.enabled == true"
# - Admin access: "auth.token.admin == true && auth.token.enabled == true"
# - System access: @auth(level: NO_ACCESS)
# See AUTH_EXPRESSIONS.md for complete documentation and usage.
#
# @auth() directives control who can call each operation.

# Get the current authenticated user's profile
# Requires enabled claim (admins must also be enabled)
query GetCurrentUser @auth(expr: "auth.token.enabled == true") {
  user(key: { id_expr: "auth.uid" }) {
    id
    firstName
    lastName
    email
    serviceNumber
    membershipStatus
    requestedMembershipStatus
    isRegular
    isReserve
    isCivilServant
    isIndustry
    createdAt
    updatedAt
  }
}

# Get a user by ID (admin only - admins must also be enabled)
query GetUserById($id: String!) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  user(id: $id) {
    id
    firstName
    lastName
    email
    serviceNumber
    membershipStatus
    requestedMembershipStatus
    isRegular
    isReserve
    isCivilServant
    isIndustry
    createdAt
    updatedAt
    createdBy
    updatedBy
  }
}

# List all users (admin only - admins must also be enabled)
query ListUsers @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  users {
    id
    firstName
    lastName
    email
    serviceNumber
    membershipStatus
    requestedMembershipStatus
    isRegular
    isReserve
    isCivilServant
    isIndustry
    createdAt
    updatedAt
  }
}

# SODC Section and Access Group Queries

# Get all sections (admin only - admins must also be enabled)
query ListSections @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  sections {
    id
    name
    type
    description
    createdAt
    updatedAt
  }
}

# Get sections accessible to the current user
# Requires enabled claim (admins must also be enabled)
query GetSectionsForUser @auth(expr: "auth.token.enabled == true") {
  user(key: { id_expr: "auth.uid" }) {
    id
    # Get access groups this user belongs to
    accessGroups: userAccessGroups_on_user {
      accessGroup {
        id
        name
        # Get sections this access group can access
        sections: sectionAccessGroups_on_accessGroup {
          section {
            id
            name
            type
            description
          }
        }
      }
    }
  }
}

# Get all access groups (admin only - admins must also be enabled)
query ListAccessGroups @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  accessGroups {
    id
    name
    description
    membershipStatuses
    createdAt
    updatedAt
  }
}

# Get access groups for the current user
# Requires enabled claim (admins must also be enabled)
query GetUserAccessGroups @auth(expr: "auth.token.enabled == true") {
  user(key: { id_expr: "auth.uid" }) {
    id
    accessGroups: userAccessGroups_on_user {
      accessGroup {
        id
        name
        description
      }
    }
  }
}


# Check if current user's profile exists and get membership status (for users without enabled claim)
# Allows users to check if they've completed profile registration and see their status
query CheckUserProfileExists @auth(level: USER) {
  user(key: { id_expr: "auth.uid" }) {
    id
    firstName
    lastName
    membershipStatus
  }
}

# Get user status for the specified user
query GetUserMembershipStatus($id: String!) @auth(level: NO_ACCESS) {
  user(id: $id) {
    membershipStatus
  }
}

# Get user by ID with access groups (admin only)
query GetUserWithAccessGroups($id: String!) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  user(id: $id) {
    id
    firstName
    lastName
    email
    membershipStatus
    accessGroups: userAccessGroups_on_user {
      accessGroup {
        id
        name
        description
      }
    }
  }
}

# Get access groups for a specific user (admin only)
query GetUserAccessGroupsById($userId: String!) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  user(id: $userId) {
    id
    accessGroups: userAccessGroups_on_user {
      accessGroup {
        id
        name
        description
      }
    }
  }
}

# Get section by ID with access groups and registration info
query GetSectionById($id: UUID!) @auth(expr: "auth.token.enabled == true") {
  section(id: $id) {
    id
    name
    type
    description
    isOpenForRegistration
    allowedAccessGroups
    accessGroups: sectionAccessGroups_on_section {
      accessGroup {
        id
        name
        description
      }
    }
  }
}

# Get access group by ID with users and sections (admin only)
query GetAccessGroupById($id: UUID!) @auth(expr: "auth.token.admin == true && auth.token.enabled == true") {
  accessGroup(id: $id) {
    id
    name
    description
    membershipStatuses
    createdAt
    updatedAt
    users: userAccessGroups_on_accessGroup {
      user {
        id
        firstName
        lastName
        email
        membershipStatus
      }
    }
    sections: sectionAccessGroups_on_accessGroup {
      section {
        id
        name
        type
        description
      }
    }
  }
}

# Get all access groups with membership statuses (SDK only - for membership status change logic)
query GetAllAccessGroupsWithStatuses @auth(level: NO_ACCESS) {
  accessGroups {
    id
    name
    membershipStatuses
  }
}