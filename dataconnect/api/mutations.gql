# SODC User Mutations

# Create or update a user profile based on their auth.uid
# The "auth.uid" server value ensures that users can only register/update their own profile.
# This mutation will create the user if they don't exist, or update if they do.
# NOTE: membershipStatus is NOT included here - it must be updated via UpdateMembershipStatus mutation
# which validates the transition server-side to prevent bypassing restrictions.
mutation UpsertUser(
  $firstName: String!
  $lastName: String!
  $email: String!
  $serviceNumber: String!
  $isRegular: Boolean
  $isReserve: Boolean
  $isCivilServant: Boolean
  $isIndustry: Boolean
) @auth(level: USER) {
  user_upsert(
    data: {
      id_expr: "auth.uid"
      firstName: $firstName
      lastName: $lastName
      email: $email
      serviceNumber: $serviceNumber
      isRegular: $isRegular
      isReserve: $isReserve
      isCivilServant: $isCivilServant
      isIndustry: $isIndustry
      # createdAt, updatedAt, createdBy, and updatedBy are set automatically via defaults
    }
  )
}


# Update a user profile (admin only - can update any user)
# NOTE: membershipStatus is NOT included here - it must be updated via updateMembershipStatus Firebase Function
# which validates the transition server-side to prevent bypassing restrictions.
mutation UpdateUser(
  $userId: String!
  $firstName: String!
  $lastName: String!
  $email: String!
  $serviceNumber: String!
  $isRegular: Boolean
  $isReserve: Boolean
  $isCivilServant: Boolean
  $isIndustry: Boolean
) @auth(expr: "auth.token.admin == true") {
  user_upsert(
    data: {
      id: $userId
      firstName: $firstName
      lastName: $lastName
      email: $email
      serviceNumber: $serviceNumber
      isRegular: $isRegular
      isReserve: $isReserve
      isCivilServant: $isCivilServant
      isIndustry: $isIndustry
      # createdAt, updatedAt, createdBy, and updatedBy are set automatically via defaults
    }
  )
}

# SODC Section and Access Group Mutations

# Create a new section (admin only)
mutation CreateSection(
  $name: String!
  $type: SectionType!
  $description: String
) @auth(expr: "auth.token.admin == true") {
  section_insert(
    data: {
      name: $name
      type: $type
      description: $description
    }
  )
}

# Create a new access group (admin only)
mutation CreateAccessGroup(
  $name: String!
  $description: String
) @auth(expr: "auth.token.admin == true") {
  accessGroup_insert(
    data: {
      name: $name
      description: $description
    }
  )
}

# Add a user to an access group (admin only)
mutation AddUserToAccessGroup(
  $userId: String!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true") {
  userAccessGroup_upsert(
    data: {
      userId: $userId
      accessGroupId: $accessGroupId
    }
  )
}

# Remove a user from an access group (admin only)
mutation RemoveUserFromAccessGroup(
  $userId: String!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true") {
  userAccessGroup_delete(
    key: {
      userId: $userId
      accessGroupId: $accessGroupId
    }
  )
}

# Grant an access group access to a section (admin only)
mutation GrantAccessGroupToSection(
  $sectionId: UUID!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true") {
  sectionAccessGroup_upsert(
    data: {
      sectionId: $sectionId
      accessGroupId: $accessGroupId
    }
  )
}

# Revoke an access group's access to a section (admin only)
mutation RevokeAccessGroupFromSection(
  $sectionId: UUID!
  $accessGroupId: UUID!
) @auth(expr: "auth.token.admin == true") {
  sectionAccessGroup_delete(
    key: {
      sectionId: $sectionId
      accessGroupId: $accessGroupId
    }
  )
}

mutation UpdateUserMembershipStatus($userId: String!, $membershipStatus: MembershipStatus!) @auth(level: NO_ACCESS) {
  user_update(
    id: $userId
    data: { membershipStatus: $membershipStatus }
  )
}