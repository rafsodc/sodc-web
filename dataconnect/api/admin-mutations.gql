# SODC Admin SDK Mutations
#
# These mutations are SDK-only and use @auth(level: NO_ACCESS).
# They can only be called from Firebase Functions or CLI scripts using the admin SDK.
# They are NOT accessible from the frontend/client SDK.
#
# Auth Expression: @auth(level: NO_ACCESS)
# See AUTH_EXPRESSIONS.md for complete documentation.

# Update user membership status (SDK only)
# Used by Firebase Functions to update membership status with server-side validation
mutation UpdateUserMembershipStatus($userId: String!, $membershipStatus: MembershipStatus!) @auth(level: NO_ACCESS) {
  user_update(
    id: $userId
    data: { membershipStatus: $membershipStatus }
  )
}

# Delete a user (SDK only)
# Used by Firebase Functions/CLI for dev reset operations
mutation DeleteUser($userId: String!) @auth(level: NO_ACCESS) {
  user_delete(id: $userId)
}

# Create a user profile (SDK only)
# Used by Firebase Functions/CLI to create user profiles
# This mutation works with service account credentials (no user auth token required)
# Note: All fields with default expressions referencing auth.uid must be set explicitly
# since auth.uid is not available in NO_ACCESS context
mutation CreateUser(
  $userId: String!
  $firstName: String!
  $lastName: String!
  $email: String!
  $serviceNumber: String!
  $membershipStatus: MembershipStatus!
  $isRegular: Boolean
  $isReserve: Boolean
  $isCivilServant: Boolean
  $isIndustry: Boolean
  $now: Timestamp!
) @auth(level: NO_ACCESS) {
  user_upsert(
    data: {
      id: $userId
      firstName: $firstName
      lastName: $lastName
      email: $email
      serviceNumber: $serviceNumber
      requestedMembershipStatus: $membershipStatus
      membershipStatus: $membershipStatus
      isRegular: $isRegular
      isReserve: $isReserve
      isCivilServant: $isCivilServant
      isIndustry: $isIndustry
      createdBy: "system"
      updatedBy: "system"
      createdAt: $now
      updatedAt: $now
    }
  )
}

# Create an access group (SDK only)
# Used by Firebase Functions to automatically create status-based access groups
mutation CreateAccessGroupAdmin(
  $name: String!
  $description: String
  $now: Timestamp!
) @auth(level: NO_ACCESS) {
  accessGroup_insert(
    data: {
      name: $name
      description: $description
      createdBy: "system"
      updatedBy: "system"
      createdAt: $now
      updatedAt: $now
    }
  )
}

# Add a user to an access group (SDK only)
# Used by Firebase Functions to automatically assign users to access groups
mutation AddUserToAccessGroupAdmin(
  $userId: String!
  $accessGroupId: UUID!
  $now: Timestamp!
) @auth(level: NO_ACCESS) {
  userAccessGroup_upsert(
    data: {
      userId: $userId
      accessGroupId: $accessGroupId
      createdBy: "system"
      updatedBy: "system"
      createdAt: $now
      updatedAt: $now
    }
  )
}

# Remove a user from an access group (SDK only)
# Used by Firebase Functions to automatically remove users from access groups
mutation RemoveUserFromAccessGroupAdmin(
  $userId: String!
  $accessGroupId: UUID!
) @auth(level: NO_ACCESS) {
  userAccessGroup_delete(
    key: {
      userId: $userId
      accessGroupId: $accessGroupId
    }
  )
}

# Get access group by name (SDK only)
# Used by Firebase Functions to find existing access groups
query GetAccessGroupByName($name: String!) @auth(level: NO_ACCESS) {
  accessGroups(where: { name: { eq: $name } }) {
    id
    name
    description
  }
}

# Get all access groups for a user (SDK only)
# Used by Firebase Functions to get user's current access groups
query GetUserAccessGroupsForAdmin($userId: String!) @auth(level: NO_ACCESS) {
  user(id: $userId) {
    id
    accessGroups: userAccessGroups_on_user {
      accessGroup {
        id
        name
        description
      }
    }
  }
}


