# SODC (Signal Officers' Dinner Club) Data Connect Schema

# Section type enum
enum SectionType {
  MEMBERS
  EVENTS
}

# Section access group purpose enum
enum SectionAccessGroupPurpose {
  VIEW
  MEMBER
}

# Membership status enum
enum MembershipStatus {
  PENDING
  REGULAR
  RESERVE
  CIVIL_SERVICE
  INDUSTRY
  RETIRED
  RESIGNED
  LOST
  DECEASED
}

# User table is keyed by Firebase Auth UID.
# Includes HasAudit fields for tracking creation and update metadata
type User @table {
  # `@default(expr: "auth.uid")` sets it to Firebase Auth UID during insert and upsert.
  id: String!
  firstName: String!
  lastName: String!
  email: String!
  serviceNumber: String!
  membershipStatus: MembershipStatus! @default(value: PENDING)
  requestedMembershipStatus: MembershipStatus
  isRegular: Boolean @default(value: false)
  isReserve: Boolean @default(value: false)
  isCivilServant: Boolean @default(value: false)
  isIndustry: Boolean @default(value: false)
  # HasAudit fields
  createdAt: Timestamp! @default(expr: "request.time")
  updatedAt: Timestamp! @default(expr: "request.time")
  createdBy: String @default(expr: "auth.uid")
  updatedBy: String @default(expr: "auth.uid")
}

# Section table - represents different sections of the application
type Section @table {
  id: UUID! @default(expr: "uuidV4()")
  name: String!
  type: SectionType!
  description: String
  isOpenForRegistration: Boolean @default(value: false)
  allowedAccessGroups: [UUID!]
  # HasAudit fields
  createdAt: Timestamp! @default(expr: "request.time")
  updatedAt: Timestamp! @default(expr: "request.time")
  createdBy: String @default(expr: "auth.uid")
  updatedBy: String @default(expr: "auth.uid")
}

# AccessGroup table - groups that control access to sections
# Can include both individual users and membership statuses (automatically includes all users with those statuses)
type AccessGroup @table {
  id: UUID! @default(expr: "uuidV4()")
  name: String!
  description: String
  membershipStatuses: [MembershipStatus!]  # Membership statuses that are automatically included in this group
  subscribable: Boolean @default(value: false)  # Whether users can self-subscribe to this access group
  # HasAudit fields
  createdAt: Timestamp! @default(expr: "request.time")
  updatedAt: Timestamp! @default(expr: "request.time")
  createdBy: String @default(expr: "auth.uid")
  updatedBy: String @default(expr: "auth.uid")
}

# UserAccessGroup - junction table linking users to access groups
# A user can be a member of multiple access groups
type UserAccessGroup @table(key: ["user", "accessGroup"]) {
  user: User!
  accessGroup: AccessGroup!
  # HasAudit fields
  createdAt: Timestamp! @default(expr: "request.time")
  updatedAt: Timestamp! @default(expr: "request.time")
  createdBy: String @default(expr: "auth.uid")
  updatedBy: String @default(expr: "auth.uid")
}

# SectionAccessGroup - junction table linking sections to access groups
# An access group can grant access to multiple sections with different purposes
type SectionAccessGroup @table(key: ["section", "accessGroup", "purpose"]) {
  section: Section!
  accessGroup: AccessGroup!
  purpose: SectionAccessGroupPurpose! @default(value: VIEW)  # VIEW: who can see the section, MEMBER: who appears in member list
  # HasAudit fields
  createdAt: Timestamp! @default(expr: "request.time")
  updatedAt: Timestamp! @default(expr: "request.time")
  createdBy: String @default(expr: "auth.uid")
  updatedBy: String @default(expr: "auth.uid")
}
